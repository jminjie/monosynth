<!DOCTYPE html>
<html>
<script src="https://unpkg.com/tone"></script>
<button id="play-button">Enable audio</button>

<script src="https://unpkg.com/@tonejs/midi"></script>

<script src="webmidiapi.js"></script>
<script>
    if (navigator.requestMIDIAccess) {
    console.log('This browser supports WebMIDI!');
} else {
    console.log('WebMIDI is not supported in this browser.');
}

navigator.requestMIDIAccess()
    .then(onMIDISuccess, onMIDIFailure);


function onMIDIFailure() {
    console.log('Could not access your MIDI devices.');
}

function onMIDISuccess(midiAccess) {
    console.log(midiAccess);

    var inputs = midiAccess.inputs;
    var outputs = midiAccess.outputs;
    for (var input of midiAccess.inputs.values()) {
        input.onmidimessage = getMIDIMessage;
    }
}

ws = new WebSocket("ws://54.177.197.224:5044");
ws.addEventListener("open", () => {
    console.log("Opened websocket");
    ws.send("Hello from the client");

    ws.addEventListener("message", ({ data }) => {
        console.log(data);
        noteInfo = data.split('-');
        let command = parseInt(noteInfo[0]);
        let byte1 = parseInt(noteInfo[1]);
        let byte2 = parseInt(noteInfo[2]);
        if (command == 144 || command == 128) {
            // command is note up or down
            playNote(command, byte1, byte2);
        } else if (command == 176 && byte1 == 64) {
            if (byte2 == 0) {
                // pedal off received from server
                pedalOff();
            } else {
                // pedal on received from server
                pedalOn();
            }
        }
    });

});

pedal = false;

pressed_keys = [];
sustained_keys = [];

function getMIDIMessage(message) {
    console.log('midi input detected');
    var command = message.data[0];
    var note = message.data[1];
    var velocity = (message.data.length > 2) ? message.data[2] : 0; // a velocity value might not be included with a noteOff command

    if (command == 144 || command == 128) {
        let midiInfo = command + '-' + note + '-' + velocity;
        //console.log("sending " + midiInfo);
        ws.send(midiInfo);
        playNote(command, note, velocity);
    }
    if (command == 176 && message.data[1] == 64) {
        // 0 off, 127 on
        let midiInfo = command + '-' + pedal_code + '-' + state;
        ws.send(midiInfo);
        if (message.data[2] == 0) {
            pedalOff();
        } else {
            pedalOn();
        }
    }
}

function pedalOff() {
    console.log("pedal off");
    pedal = false;
    release_keys = getSustainedKeysWhichArentPressed();
    //release_keys = getAllKeysWhichArentPressed();
    console.log(release_keys);
    sampler.triggerRelease(release_keys, Tone.context.currentTime)
    sustained_keys = [];
}

function pedalOn() {
    console.log("pedal on");
    pedal = true;
}

NOTES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"]
ALL_KEYS = []
for (let i = 0; i < 88; i++) {
    ALL_KEYS.push(NOTES[i%12] + (Math.floor(i/12)).toString());
}

function getAllKeysWhichArentPressed() {
    let toReturn = [];
    for (let i = 0; i < ALL_KEYS.length; i++) {
        if (!pressed_keys.includes(ALL_KEYS[i])) {
            toReturn.push(ALL_KEYS[i]);
        }
    }
    return toReturn;
}

function getSustainedKeysWhichArentPressed() {
    let toReturn = [];
    for (let i = 0; i < sustained_keys.length; i++) {
        if (!pressed_keys.includes(sustained_keys[i])) {
            toReturn.push(sustained_keys[i]);
        }
    }
    return toReturn;
}

function playNote(command, note, velocity) {
    //console.log("playing " + command + '-' + note + '-' + velocity);
    switch (command) {
        case 144: // keyDown
            if (velocity > 0) {
                keyDown(note, velocity);
            } else {
                keyUp(note);
            }
            break;
        case 128: // keyUp
            keyUp(note);
            break;
        case 176:

    }
}

//const synth = new Tone.AMSynth().toDestination()
const sampler = new Tone.Sampler({
	urls: {
		A2: "A2.mp3",
		A3: "A3.mp3",
		A4: "A4.mp3",
		A5: "A5.mp3",
	},
	//baseUrl: "https://tonejs.github.io/audio/casio/",
    baseUrl: "https://tonejs.github.io/audio/salamander/",
}).toDestination();

function keyDown(midiValue, velocity) {
    let note = getNote(midiValue);
    pressed_keys.push(note);
    sustained_keys.push(note);
    sampler.triggerAttack(note, Tone.context.currentTime, velocity/90)
}

function keyUp(midiValue) {
    let note = getNote(midiValue);
    for (let i = 0; i < pressed_keys.length; i++) {
        if (pressed_keys[i] == note) {
            delete pressed_keys[i];
        }
    }
    if (!pedal) {
        sampler.triggerRelease(note, Tone.context.currentTime)
    }
}


function getNote(midiValue) {
    let noteLetter = NOTES[midiValue%12];
    let octave = midiValue/12 - 1;
    return noteLetter + octave;
}

</script>
</html>
